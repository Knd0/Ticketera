<div class="checkout-container fade-in" *ngIf="purchaseSuccess; else checkoutFlow">
    <!-- Success View -->
    <div class="success-container">
        <div class="success-header">
            <h2>üéâ Purchase Successful!</h2>
            <p>Your order ID: {{ purchasedOrder?.id }}</p>
            <p class="email-note">We sent a copy to {{ purchasedOrder?.customerEmail }}</p>
        </div>

        <div class="tickets-list">
            <div class="ticket-card" *ngFor="let ticket of purchasedTickets; let i = index">
                <div class="ticket-info">
                    <h3>Ticket #{{ i + 1 }}</h3>
                    <p class="code">Code: {{ ticket.code }}</p>
                </div>
                <div class="qr-code">
                    <img [src]="ticket.qrCode" alt="QR Code">
                </div>
                <!-- Mock Download -->
                <a [href]="ticket.qrCode" download="ticket-{{ticket.code}}.png"
                    class="btn btn-sm btn-outline">Download</a>
            </div>
        </div>

        <a routerLink="/" class="btn btn-primary btn-full" style="margin-top: 2rem;">Back to Home</a>
    </div>
</div>

<ng-template #checkoutFlow>
    <div class="container checkout-layout">
        <h1 class="page-title">Comprando</h1>

        <!-- 1. Event/Product Row -->
        <div class="product-summary-card" *ngIf="event && batch">
            <div class="product-row header-row">
                <span class="col-event">Evento</span>
                <span class="col-product">Producto</span>
                <span class="col-price">Precio</span>
                <span class="col-qty">Cantidad</span>
                <span class="col-total">Sub Total</span>
            </div>
            <div class="product-row content-row">
                <div class="col-event event-details">
                    <div class="event-thumb"
                        [style.background-image]="'url(' + (event.imageUrl || 'assets/placeholder.jpg') + ')'"></div>
                    <div class="event-text">
                        <h4>{{ event.title }}</h4>
                        <span class="event-date">{{ event.date | date:'mediumDate' }} at {{ event.date |
                            date:'shortTime' }}</span>
                    </div>
                </div>
                <div class="col-product product-name">
                    {{ batch.name }}
                </div>
                <div class="col-price">
                    {{ unitPrice | currency }}
                </div>
                <div class="col-qty">
                    {{ quantity }}
                </div>
                <div class="col-total">
                    {{ subTotal | currency }}
                </div>
                <!-- Remove button 'x' placeholder -->
            </div>
        </div>

        <!-- 2. Timer Header -->
        <div class="timer-bar">
            <span class="timer-icon">üïí</span>
            <span class="timer-value">{{ timerDisplay }}</span>
            <p>Tienes 10 minutos para realizar la compra.</p>
        </div>

        <!-- 3. Form & Payment Grid -->
        <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="checkout-grid">

            <!-- Left: Buyer Data -->
            <div class="buyer-section">
                <h2>Datos del Comprador</h2>

                <div class="form-group">
                    <label>Nombre y Apellido</label>
                    <input type="text" formControlName="fullName" class="input-field" placeholder="Nombre y apellido">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" formControlName="email" class="input-field"
                        placeholder="Ingresa tu correo electr√≥nico">
                </div>

                <div class="form-group">
                    <label>Repetir Email</label>
                    <input type="email" formControlName="confirmEmail" class="input-field" placeholder="Repetir email">
                </div>

                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" formControlName="phone" class="input-field" placeholder="+549 Tu tel√©fono">
                </div>

                <div class="form-group">
                    <label>DNI / Passport ID</label>
                    <input type="text" formControlName="documentId" class="input-field"
                        placeholder="Ingresa tu DNI/ Pasaporte ID">
                </div>
            </div>

            <!-- Right: Payment & Summary -->
            <div class="payment-summary-section">
                <!-- Payment Methods -->
                <!-- Note: Added warning box from screenshot -->
                <div class="warning-box">
                    ATENCI√ìN: Verifica que tu correo y tel√©fono sean correctos: all√≠ recibir√°s los accesos al evento.
                </div>

                <h3>Selecciona tu forma de pago</h3>
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" formControlName="paymentMethod" value="credit_card">
                        <span class="radio-label">Pago con Cr√©dito/ D√©bito/ Cuotas</span>
                        <div class="logos">
                            <span class="logo-box">üí≥</span> Visa/Master
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" formControlName="paymentMethod" value="mercadopago">
                        <span class="radio-label">Mercado Cr√©dito / Pago</span>
                        <div class="logos">
                            <span class="logo-box">ü§ù</span> MP
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" formControlName="paymentMethod" value="paypal">
                        <span class="radio-label">International Payments</span>
                        <div class="logos">
                            <span class="logo-box">üÖøÔ∏è</span> PayPal
                        </div>
                    </label>
                </div>

                <!-- Price Summary -->
                <div class="price-summary-box">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span>{{ subTotal | currency }}</span>
                    </div>

                    <!-- Promo Code Input Mock inside Summary -->
                    <div class="promo-row">
                        <div class="promo-input-group">
                            <input type="text" [(ngModel)]="promoCode" [ngModelOptions]="{standalone: true}"
                                placeholder="Promo Code" [disabled]="promoApplied">
                            <button type="button" (click)="applyPromo()" [disabled]="promoApplied">Apply</button>
                        </div>
                        <div class="discount-display" *ngIf="promoApplied">
                            Saved: -{{ discountAmount | currency }}
                        </div>
                    </div>

                    <div class="summary-row fee-row">
                        <span>Cargo por servicio</span>
                        <span>{{ serviceFee | currency }}</span>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-row total-row">
                        <span>Total</span>
                        <span>{{ finalTotal | currency }}</span>
                    </div>

                    <p class="terms-text">Por favor, verifica tus datos antes de realizar la compra.</p>

                    <button type="submit" [disabled]="checkoutForm.invalid" class="btn btn-block btn-pay">
                        COMPRAR
                    </button>
                </div>
            </div>

        </form>
    </div>
</ng-template>