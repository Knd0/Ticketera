<div class="container">
    <h2>My Tickets</h2>

    <ng-container *ngIf="{ valid: validTickets$ | async, past: pastTickets$ | async } as data">

        <!-- Loading -->
        <div *ngIf="!data.valid && !data.past" class="empty-state">
            <p>Loading your tickets...</p>
        </div>

        <div *ngIf="data.valid || data.past">

            <!-- Valid Tickets -->
            <div *ngIf="data.valid && data.valid.length > 0">
                <h3 class="section-title">Upcoming Events</h3>
                <div class="tickets-list">
                    <div class="ticket-card clickable" *ngFor="let ticket of data.valid" (click)="openQrModal(ticket)">
                        <div class="ticket-image">
                            <img [src]="ticket.batch?.event?.imageUrl || 'assets/placeholder-event.jpg'"
                                alt="Event Cover">
                            <div class="date-badge">
                                <span class="day">{{ ticket.batch?.event?.date | date:'dd' }}</span>
                                <span class="month">{{ ticket.batch?.event?.date | date:'MMM' }}</span>
                            </div>
                        </div>

                        <div class="ticket-details">
                            <h3>{{ ticket.batch?.event?.title || 'Unknown Event' }}</h3>
                            <div class="ticket-info">
                                <span><i class="fas fa-map-marker-alt"></i> {{ ticket.batch?.event?.location || 'TBA'
                                    }}</span>
                                <span><i class="far fa-clock"></i> {{ ticket.batch?.event?.date | date:'shortTime'
                                    }}</span>
                            </div>
                            <span class="tier-badge">{{ ticket.batch?.name }}</span>
                            <span class="seat-badge" *ngIf="ticket.seatRow">
                                ðŸ’º Row {{ ticket.seatRow }} - Seat {{ ticket.seatNumber }}
                            </span>
                        </div>

                        <div class="ticket-qr-section">
                            <div class="qr-code" *ngIf="ticket.qrCode && ticket.order?.status === 'PAID'">
                                <img [src]="ticket.qrCode" alt="QR Code">
                            </div>
                            <div class="qr-placeholder"
                                *ngIf="['PENDING_APPROVAL', 'REJECTED'].includes(ticket.order?.status)">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>

                            <div class="status-badge valid" *ngIf="ticket.order?.status === 'PAID'">
                                <i class="fas fa-check-circle"></i> Valid Entry
                            </div>
                            <!-- Show Pending for both PENDING and REJECTED as requested -->
                            <div class="status-badge pending"
                                *ngIf="['PENDING_APPROVAL', 'REJECTED'].includes(ticket.order?.status)">
                                <i class="fas fa-hourglass-half"></i> Pending Approval
                            </div>

                            <span class="ticket-id">#{{ ticket.code | slice:0:8 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Past Tickets -->
            <div *ngIf="data.past && data.past.length > 0">
                <h3 class="section-title" style="margin-top: 2rem;">History</h3>
                <div class="tickets-list">
                    <div class="ticket-card used" *ngFor="let ticket of data.past">
                        <div class="ticket-image">
                            <img [src]="ticket.batch?.event?.imageUrl || 'assets/placeholder-event.jpg'"
                                alt="Event Cover">
                        </div>

                        <div class="ticket-details">
                            <h3>{{ ticket.batch?.event?.title }}</h3>
                            <div class="ticket-info">
                                <span>{{ ticket.batch?.event?.date | date:'mediumDate' }}</span>
                            </div>
                            <span class="tier-badge" style="background: #555;">{{ ticket.batch?.name }}</span>
                            <span class="seat-badge" *ngIf="ticket.seatRow"
                                style="background: #e5e7eb; color: #6b7280;">
                                Row {{ ticket.seatRow }} - Seat {{ ticket.seatNumber }}
                            </span>
                        </div>

                        <div class="ticket-qr-section">
                            <div class="status-badge used">
                                {{ ticket.isUsed ? 'Used' : 'Expired' }}
                            </div>
                            <span class="ticket-id">#{{ ticket.code | slice:0:8 }}</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Empty State -->
        <div *ngIf="data.valid?.length === 0 && data.past?.length === 0" class="empty-state">
            <i class="fas fa-ticket-alt"></i>
            <p>You haven't purchased any tickets yet.</p>
            <button routerLink="/" class="btn-primary"
                style="margin-top: 1rem; padding: 10px 20px; background: #9d4edd; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Browse Events
            </button>
        </div>

    </ng-container>

    <!-- Full Screen QR Modal -->
    <div class="qr-modal-backdrop" *ngIf="selectedTicket" (click)="closeQrModal()">
        <div class="qr-modal-content" (click)="$event.stopPropagation()">
            <button class="close-modal-btn" (click)="closeQrModal()">Ã—</button>

            <div class="modal-header">
                <h3>{{ selectedTicket.batch?.event?.title || 'Event' }}</h3>
                <p>{{ selectedTicket.batch?.event?.date | date:'fullDate' }}</p>
                <div *ngIf="selectedTicket.seatRow" class="modal-seat-info">
                    Row {{ selectedTicket.seatRow }} | Seat {{ selectedTicket.seatNumber }}
                </div>
            </div>

            <div class="qr-container-large">
                <img [src]="selectedTicket.qrCode" alt="QR Code">
            </div>

            <div class="ticket-code-display">
                <span class="label">Ticket Code</span>
                <span class="code">{{ selectedTicket.code }}</span>
            </div>

            <div class="modal-status"
                [ngClass]="{'modal-valid': !selectedTicket.isUsed, 'modal-used': selectedTicket.isUsed}">
                <i class="fas" [ngClass]="selectedTicket.isUsed ? 'fa-history' : 'fa-check-circle'"></i>
                {{ selectedTicket.isUsed ? 'Already Used' : 'Ready to Scan' }}
            </div>
        </div>
    </div>
</div>